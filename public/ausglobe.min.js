/*!
 * Copyright(c) 2012-2013 National ICT Australia Limited (NICTA).  All rights reserved.
 */

!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.ausglobe=e()}}(function(){return function e(t,r,a){function i(s,n){if(!r[s]){if(!t[s]){var l="function"==typeof require&&require;if(!n&&l)return l(s,!0);if(o)return o(s,!0);throw new Error("Cannot find module '"+s+"'")}var u=r[s]={exports:{}};t[s][0].call(u.exports,function(e){var r=t[s][1][e];return i(r?r:e)},u,u.exports,e,t,r,a)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<a.length;s++)i(a[s]);return i}({1:[function(e,t){"use strict";function r(e,t){return Math.abs((e-t)/t)<1e-5}var a=e("./Variable"),i=Cesium.defaultValue,o={},s={LON:0,LAT:1,ALT:2,TIME:3,SCALAR:4,ENUM:5},n=function(){this._nodataVal=1e-34,this._rowCnt=0,this._dataShape=void 0,this._varID=[],this._variables=void 0,this._loadingData=!1};n.prototype.getExtent=function(){var e=[0,0,0],t=[0,0,0],r=[s.LON,s.LAT,s.ALT];for(var a in r)this._varID[r[a]]&&(e[a]=this._variables[this._varID[r[a]]].min,t[a]=this._variables[this._varID[r[a]]].max);return Cesium.Rectangle.fromDegrees(e[0],e[1],t[0],t[1])},n.prototype.getMinVal=function(){return this._variables&&this._varID[s.SCALAR]?this._variables[this._varID[s.SCALAR]].min:void 0},n.prototype.getMaxVal=function(){return this._variables&&this._varID[s.SCALAR]?this._variables[this._varID[s.SCALAR]].max:void 0},n.prototype.getMinTime=function(){return this._variables&&this._varID[s.TIME]?this._variables[this._varID[s.TIME]].time_var.min:void 0},n.prototype.getMaxTime=function(){return this._variables&&this._varID[s.TIME]?this._variables[this._varID[s.TIME]].time_var.max:void 0},n.prototype.getVarList=function(){var e=[];for(var t in this._variables)(this._variables[t].type===s.SCALAR||this._variables[t].type===s.ENUM)&&e.push(t);return e},n.prototype._processVariables=function(){this._varID=[];for(var e in this._variables){var t=this._variables[e];void 0===t.type&&t.guessVarType(e),t.type===s.TIME&&(t.processTimeVar(),void 0===t.time_var&&(t.type=s.SCALAR)),t.type!==s.TIME&&t._calculateVarMinMax(),t.type===s.SCALAR&&t.min>t.max&&(t.type=s.ENUM,t.processEnumVar());for(var r in s)void 0===this._varID[s[r]]&&t.type===s[r]&&(this._varID[s[r]]=e)}this._var_name&&this._var_name.length&&this._variables[this._var_name]&&(this._varID[s.SCALAR]=this._var_name),void 0===this._varID[s.SCALAR]&&(this._varID[s.SCALAR]=this._varID[s.ENUM]),this._rowCnt=this._variables[this._varID[s.SCALAR]].vals.length,void 0===this._dataShape&&(this._dataShape=[this._rowCnt])},n.prototype.loadJson=function(e){this._dataShape=void 0,this._variables={};for(var t=e[0],r=0;r<t.length;r++){for(var i=t[r],o=new a,s=1;s<e.length;++s)o.vals.push(e[s][r]);this._variables[i]=o}this._processVariables(),this._var_name&&this.setCurrentVariable({variable:this._var_name}),console.log(this),this._loadingData=!1},n.prototype.loadText=function(e){var t=$.csv.toArrays(e,{onParseValue:$.csv.hooks.castToScalar});this.loadJson(t)},n.prototype.loadUrl=function(e){if(e=i(e,o),this._url=i(e.url,this._url),this._var_name=i(e.variable,""),this._url){console.log("loading: "+this._url),this._loadingData=!0;var t=this;Cesium.when(Cesium.loadText(this._url),function(e){t.loadText(e)})}},n.prototype.setCurrentVariable=function(e){this._variables[e.variable]&&0!==this._variables[e.variable].vals.length&&(this._var_name=e.variable,this._var_name.length&&this._variables[this._var_name]&&(this._varID[s.SCALAR]=this._var_name))},n.prototype.getCurrentVariable=function(){return this._varID[s.SCALAR]},n.prototype.getDataValue=function(e,t){var r=this._variables[e];return void 0===r||void 0===r.vals?void 0:r.type===s.ENUM?r.enum_list[r.vals[t]]:r.type===s.TIME?r.time_var.vals[t]:r.vals[t]},n.prototype.getDataValues=function(e){return void 0===this._variables[e]||void 0===this._variables[e].vals?void 0:this._variables[e].vals},n.prototype.isNoData=function(e){return r(this._nodataVal,e)},n.prototype.getPointList=function(e){var t=this._varID[s.LON]?this._variables[this._varID[s.LON]].vals:void 0,r=this._varID[s.LAT]?this._variables[this._varID[s.LAT]].vals:void 0,a=this._varID[s.ALT]?this._variables[this._varID[s.ALT]].vals:void 0,i=this._variables[this._varID[s.SCALAR]].vals,o=this._varID[s.TIME]?this._variables[this._varID[s.TIME]].time_var.vals:void 0;void 0===e&&(e=i.length);for(var n=[],l=0;l<i.length&&e>l;l++){var u={val:i[l]};u.time=o?o[l]:void 0,u.pos=[t?t[l]:0,r?r[l]:0,a?a[l]:0],n.push(u)}return n},n.prototype.destroy=function(){return Cesium.destroyObject(this)},t.exports=n},{"./Variable":5}],2:[function(e,t){"use strict";var r=Cesium.defaultValue,a=function(e){this.name=r(e.name,"New Item"),this.show=r(e.show,!0),this.type=r(e.type,"UNKNOWN"),this.primitive=r(e.primitive,void 0),this.extent=r(e.extent,void 0),this.url=r(e.url,void 0),this.style=r(e.style,void 0)};t.exports=a},{}],3:[function(e,t){"use strict";function r(e,t){var r=e.length,a=t.length;return r>a&&-1!==e.indexOf(t,r-a)}function a(e){if(void 0===e.geometryType||void 0===e.features||"FeatureCollection"===e.type)return e;e.type="FeatureCollection",e.crs={type:"EPSG",properties:{code:"4326"}};for(var t=0;t<e.features.length;t++){var r=e.features[t];if(r.type="Feature",r.properties=r.attributes,"esriGeometryPoint"===e.geometryType){var a=[r.geometry.x,r.geometry.y],i={type:"Point",coordinates:a};r.geometry=i}else if("esriGeometryPolyline"===e.geometryType){var a=r.geometry.paths[0],i={type:"LineString",coordinates:a};r.geometry=i}else if("esriGeometryPolygon"===e.geometryType){var a=r.geometry.paths[0],i={type:"Polygon",coordinates:a};r.geometry=i}}return e}function i(e){for(var t=e.split(/[ ,]+/),r=[],a=0;a<t.length;a+=2)r.push([parseFloat(t[a+1]),parseFloat(t[a])]);return r}function o(e,t){var r={type:"Feature"},a="Point"===t?i(e.pos)[0]:i(e.posList);return r.geometry={type:t,coordinates:a},r}function s(e){for(var t={type:"FeatureCollection",crs:{type:"EPSG",properties:{code:"4326"}},features:[]},r=0;r<e.featureMember.length;r++)y(e.featureMember[r],"Point",function(e){t.features.push(o(e,"Point"))}),y(e.featureMember[r],"LineString",function(e){t.features.push(o(e,"LineString"))}),y(e.featureMember[r],"Polygon",function(e){t.features.push(o(e,"Polygon"))});return t}function n(e,t){for(var r=0;r<e.length;r++)e[r].Layer?(1===e[r].queryable&&t.push(e[r]),n(e[r].Layer,t)):t.push(e[r])}function l(e){return function(t){return c(t,e)}}function u(e){Cesium.loadText("http://spatialreference.org/ref/epsg/"+e.substring(5)+"/proj4/").then(function(t){console.log("Adding new string for ",e,": ",t," before loading datasource")})}function p(e){if(void 0===e.crs||"EPSG"!==e.crs.type)return"";var t=e.crs.properties.code;return e.crs.type+":"+t}function h(e){return void 0!==Cesium.GeoJsonDataSource.crsNames[e]}function c(e,t){var r=new proj4.Proj(proj4_epsg[t]),a=new proj4.Proj("EPSG:4326"),i=new proj4.Point(e[0],e[1]);proj4(r,a,i);var o=Cesium.Cartographic.fromDegrees(i.x,i.y);return Cesium.Ellipsoid.WGS84.cartographicToCartesian(o)}function v(e,t){var r=Math.min(e.west,t.west),a=Math.min(e.south,t.south),i=Math.max(e.east,t.east),o=Math.max(e.north,t.north);return new Cesium.Rectangle(r,a,i,o)}function f(e){for(var t,r,a=e.dynamicObjects,i=a.getObjects(),o=new Cesium.JulianDate,s=0;s<i.length;s++){if(i[s].vertexPositions)var n=i[s].vertexPositions.getValue(o);else{if(!i[s].position)continue;var n=[i[s].position.getValue(o)]}var r=Cesium.Ellipsoid.WGS84.cartesianArrayToCartographicArray(n),l=Cesium.Rectangle.fromCartographicArray(r);t=void 0===t?l:v(t,l)}return t}function d(e,t,r){if(!(e[0]instanceof Array))return e;if(e.length<100)return e;for(var a,i=[],o=0;o<e.length;o+=a)for(i.push(e[o]),a=1;r>a&&!(o+a>=e.length)&&!(Math.abs(e[o][0]-e[o+a][0])+Math.abs(e[o][1]-e[o+a][1])>t);a++);return console.log(e.length,"points reduced to",i.length),i}function y(e,t,r){for(var a in e)e.hasOwnProperty(a)!==!1&&(void 0!==e[t]?r&&"function"==typeof r&&r(e[t]):"object"==typeof e[a]&&y(e[a],t,r))}function m(e){y(e,"coordinates",function(e){e=w(e,function(e){return d(e,.01,20)})})}function g(e){var t=e[A++%e.length];return new Cesium.Color(t[0]/255,t[1]/255,t[2]/255,t[3]/255)}function C(e){return e instanceof Cesium.Color?e:new Cesium.Color(e.red,e.green,e.blue,e.alpha)}var _=e("./TableDataSource"),S=e("./GeoData"),D=(Cesium.defaultValue,function(){this.layers=[],this.shareRequest=!1,this.visStore="http://geospace.research.nicta.com.au:3000";var e=this;this.dataSourceCollection=new Cesium.DataSourceCollection,this.GeoDataAdded=new Cesium.Event,this.GeoDataRemoved=new Cesium.Event,this.ViewerChanged=new Cesium.Event,this.ShareRequest=new Cesium.Event,Cesium.loadJson("./data_sources.json").then(function(t){e.serviceList=t})});D.prototype.setViewer=function(e){{var t=e.scene;e.map}t?(this.dataSourceDisplay=new Cesium.DataSourceDisplay(t,this.dataSourceCollection),this.imageryLayersCollection=t.globe.imageryLayers):void 0!==this.dataSourceDisplay&&this.dataSourceDisplay.destroy(),this.ViewerChanged.raiseEvent(this,e);for(var r=0;r<this.layers.length;r++)console.log("Redisplay Layer",this.layers[r].name),this.layers[r].map=e.map,this.layers[r].skip=!0,this.sendLayerRequest(this.layers[r])},D.prototype.setShareRequest=function(e){this.shareRequest=!1;var t=this.getShareRequest(e);this.ShareRequest.raiseEvent(this,t)},D.prototype._getUniqueLayerName=function(e){for(var t=e,r=!0,a=1;r;){r=!1;for(var i=0;i<this.layers.length;i++)this.layers[i].name===e&&(r=!0);r&&(e=t+" ("+a+")",a++)}return e},D.prototype.update=function(e){void 0===this.dataSourceDisplay||this.dataSourceDisplay.isDestroyed()||this.dataSourceDisplay.update(e)},D.prototype.add=function(e){return e.skip?(e.skip=!1,e):(e.name=this._getUniqueLayerName(e.name),this.layers.push(e),this.GeoDataAdded.raiseEvent(this,e),e)},D.prototype.get=function(e){return this.layers[e]},D.prototype.remove=function(e){var t=this.get(e);t.dataSource?this.dataSourceCollection.contains(t.dataSource)?this.dataSourceCollection.remove(t.dataSource):t.dataSource.destroy():this.imageryLayersCollection.remove(t.primitive),this.layers.splice(e,1),this.GeoDataRemoved.raiseEvent(this,t)},D.prototype.show=function(e,t){e.show=t,e.dataSource?t?this.dataSourceCollection.add(e.dataSource):this.dataSourceCollection.remove(e.dataSource,!1):e.primitive.show=t},D.prototype._stringify=function(){for(var e=[],t=0;t<this.layers.length;t++){var r={};for(var a in this.layers[t])this.layers[t].hasOwnProperty(a)&&"primitive"!==a&&"dataSource"!==a&&(r[a]=this.layers[t][a]);e.push(r)}return JSON.stringify(e)},D.prototype._parse=function(e){for(var t=JSON.parse(e),r=[],a=0;a<t.length;a++){var i=t[a];for(var o in i)if(i[o].west){var s=i[o];i[o]=new Cesium.Rectangle(s.west,s.south,s.east,s.north)}r.push(i)}return r},D.prototype.loadUrl=function(e){var t=new URI(e),r={vis_server:this.visStore,vis_id:void 0,data_url:void 0},a=t.search(!0);$.extend(r,a),this.visStore=r.vis_server,this.visID=r.vis_id,this.dataUrl=r.data_url;var i=this;if(this.visID){var e=this.visStore+"/get_rec?vis_id="+this.visID;Cesium.when(Cesium.loadJson(e),function(e){console.log(e),i.visID=e._id;for(var t=(JSON.parse(e.camera),i._parse(e.layers)),r=0;r<t.length;r++)i.sendLayerRequest(t[r])})}else this.dataUrl&&Cesium.loadText(this.dataUrl).then(function(e){i.loadText(e,i.dataUrl)})},D.prototype.getShareRequest=function(e){var t={};t.title="",t.description="";for(var r=[],a=0;a<this.layers.length;a++)r.push(this.layers[a].name);t.tags=r.toString(),t.layers=this._stringify(),t.version="0.0.01",t.image=e.image;var i=e.camera;return void 0!==i&&(t.camera=JSON.stringify({e:i.positionWC,v:i.directionWC,u:i.upWC})),this.visID&&(t.parent=this.visID),t},D.prototype.formatSupported=function(e){for(var t=[".CZML",".GEOJSON",".JSON",".TOPOJSON",".KML",".GPX",".CSV"],a=e.toUpperCase(),i=0;i<t.length;i++)if(r(a,t[i]))return!0;return!1},D.prototype.loadText=function(e,t){var a=t.toUpperCase();if(console.log(a),r(a,".CZML")){var i=new Cesium.CzmlDataSource;i.load(JSON.parse(e)),this.dataSourceCollection.add(i),n=new S({name:t,type:"DATA"}),n.dataSource=i,n.extent=f(i),this.add(n)}else if(r(a,".GEOJSON")||r(a,".JSON")||r(a,".TOPOJSON"))n=new S({name:t,type:"DATA"}),this.addGeoJsonLayer(JSON.parse(e),t,n),this.add(n);else if(r(a,".KML")){n=new S({name:t,type:"DATA"});var o=(new DOMParser).parseFromString(e,"text/xml");this.addGeoJsonLayer(toGeoJSON.kml(o),t,n),this.add(n)}else if(r(a,".GPX")){n=new S({name:t,type:"DATA"});var o=(new DOMParser).parseFromString(e,"text/xml");this.addGeoJsonLayer(toGeoJSON.gpx(o),t,n),this.add(n)}else{if(!r(a,".CSV"))return console.log("There is no handler for this file based on its extension : "+t),!1;var s=new _;s.loadText(e),this.dataSourceCollection.add(s);var n=new S({name:t,type:"DATA"});n.dataSource=s,n.extent=s.dataset.getExtent(),this.add(n)}return!0},D.prototype._viewFeature=function(e,t){var r=this;if(console.log("GeoJSON request",e),t.proxy){var i=new Cesium.DefaultProxy("/proxy/");e=i.getURL(e)}Cesium.when(Cesium.loadText(e),function(e){var i;if("{"===e[0])i=JSON.parse(e),i=a(i);else if(i=$.xml2json(e),i=s(i),-1!=e.indexOf("gazetter"))for(var o=0;o<i.features.length;o++){var n=i.features[o].geometry.coordinates,l=n[0];n[0]=n[1],n[1]=l}t=r.addGeoJsonLayer(i,t.name+".geojson",t),r.add(t)})},D.prototype._viewMap=function(e,t){if(void 0===t.map){var r,a,i=new URI(e),o=(e.substring(0,e.indexOf("?")),i.search(!0)),s=o.layers,n="http://"+i.hostname()+i.path();t.proxy&&(a=new Cesium.DefaultProxy("/proxy/")),r="REST"===s?new Cesium.ArcGisMapServerImageryProvider({url:n,proxy:a}):new Cesium.WebMapServiceImageryProvider({url:n,layers:encodeURIComponent(s),parameters:{format:"image/png",transparent:"true",styles:""},proxy:a}),t.primitive=this.imageryLayersCollection.addImageryProvider(r)}else{var i=new URI(e),l=e.substring(0,e.indexOf("?")),o=i.search(!0),s=o.layers;t.proxy&&(a=new Cesium.DefaultProxy("/proxy/"),l=a.getURL(l),"REST"!==s&&(l+="%3f")),r="REST"===s?new L.esri.TiledMapLayer(l):new L.tileLayer.wms(l,{layers:s,format:"image/png",transparent:!0}),t.map.addLayer(r)}this.add(t)},D.prototype._viewTable=function(e,t){var r=this;Cesium.when(Cesium.loadText(e),function(e){var a=new _;if(a.loadText(e),void 0===t.map)r.dataSourceCollection.add(a),t.dataSource=a;else{for(var i=a.dataset.getPointList(),o=[],s=0;s<i.length;s++)o.push({type:"Point",coordinates:i[s].pos});L.geoJson(o).addTo(t.map)}r.add(t)})},D.prototype.sendLayerRequest=function(e){var t=e.url;if(console.log("LAYER REQUEST:",t),"WFS"===e.type||"REST"===e.type||"CKAN"===e.type||"GME"===e.type)this._viewFeature(t,e);else if("WMS"===e.type)this._viewMap(t,e);else{if("CSV"!==e.type)throw new DeveloperError("Creating layer for unsupported service: "+e.type);this._viewTable(t,e)}},D.prototype.getOGCFeatureURL=function(e){console.log("Getting ",e.feature);var t=e.base_url,r=encodeURIComponent(e.Name);if("WMS"===e.type)return t+="?service=wms&request=GetMap&layers="+r;if("WFS"===e.type)e.version=1.1,t+="?service=wfs&request=GetFeature&typeName="+r+"&version="+e.version+"&srsName=EPSG:4326",-1!==t.indexOf("www.ga.gov.au")&&(e.esri=!0),void 0===e.esri&&(t+="&outputFormat=JSON"),e.count&&(t+="&maxFeatures="+e.count);else{if("REST"!==e.type)throw new Cesium.DeveloperError("Getting feature for unsupported service: "+e.type);t+="/"+e.idx,t+="/query?geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&returnGeometry=true&f=pjson"}if(e.extent){var a=e.extent,i=[Cesium.Math.toDegrees(a.west),Cesium.Math.toDegrees(a.south),Cesium.Math.toDegrees(a.east),Cesium.Math.toDegrees(a.north)],o=parseFloat(e.version);t="WFS"===e.type&&1.1>o?t+"&bbox="+i[0]+","+i[1]+","+i[2]+","+i[3]:"REST"===e.type?t+"&geometry="+i[0]+","+i[1]+","+i[2]+","+i[3]:t+"&bbox="+i[1]+","+i[0]+","+i[3]+","+i[2]+",urn:x-ogc:def:crs:EPSG:6.9:4326"}return t},D.prototype.handleCapabilitiesRequest=function(e,t){var r;r="{"===e[0]?JSON.parse(e):$.xml2json(e),console.log(r);var a=[];if("WFS"===t.type)a=r.FeatureTypeList.FeatureType;else if("WMS"===t.type){var i=[r.Capability.Layer];n(i,a)}else if("REST"===t.type){a=r.layers;for(var o=0;o<a.length;o++)a[o].Name=a[o].name;var s=r.fullExtent;t.extent=Cesium.Rectangle.fromDegrees(parseFloat(s.xmin),parseFloat(s.ymin),parseFloat(s.xmax),parseFloat(s.ymax))}else if("CSV"===t.type)a=r.Layer;else if("GME"===t.type)a=r.Layer;else{if("CKAN"!==t.type)throw new DeveloperError("Getting capabilities for unsupported service: "+t.type);a=r.result.results;for(var o=0;o<a.length;o++)a[o].Name=a[o].name;t.extent}r.ServiceIdentification?t.version=parseFloat(r.ServiceIdentification.ServiceTypeVersion):r.Service&&(t.version=parseFloat(r.version)),t.Layer=a},D.prototype.getCapabilities=function(e,t){var r;if(r="CSV"===e.type||"GME"===e.type?e.base_url:"REST"===e.type?e.base_url+"?f=pjson":"CKAN"===e.type?e.base_url+"/api/3/action/package_search?q=GeoJSON&rows=50":e.base_url+"?service="+e.type+"&request=GetCapabilities",e.proxy){var a=new Cesium.DefaultProxy("/proxy/");r=a.getURL(r)}console.log("CAPABILITIES REQUEST:",r);var i=this;Cesium.when(Cesium.loadText(r),function(r){i.handleCapabilitiesRequest(r,e),t(e)})};for(var b in proj4_epsg)Cesium.GeoJsonDataSource.crsNames[b]=l(b);var w=function(e,t){if(!(e[0]instanceof Array&&e[0][0]instanceof Array))return e=t(e);for(var r=0;r<e.length;r++)e[r]=w(e[r],t);return e},T=function(e,t){if(e[0]instanceof Array)if(e[0][0]instanceof Array)for(var r=0;r<e.length;r++)T(e[r],t);else t.tot+=e.length,e.length>t.longest&&(t.longest=e.length);else t.tot++},x=[[204,197,24,255],[104,197,124,255],[104,107,224,255],[230,87,74,255],[104,197,24,255],[104,227,124,255],[104,227,124,255]],M=[[200,200,0,255],[200,0,0,255],[0,200,200,255],[0,200,0,255],[0,0,200,255],[200,0,200,255],[200,200,200,255]],A=0;D.prototype.addGeoJsonLayer=function(e,t,r){void 0===r.style&&(r.style={line:{},point:{},polygon:{}},r.style.line.color=g(x),r.style.line.width=2,r.style.point.color=g(M),r.style.point.size=10,r.style.polygon.color=r.style.line.color,r.style.polygon.fill=!1,r.style.polygon.fillcolor=r.style.line.color,r.style.polygon.fillcolor.alpha=.5);var a=new Cesium.GeoJsonDataSource,i=a.defaultPoint,o=new Cesium.DynamicPoint;o.color=new Cesium.ConstantProperty(C(r.style.point.color)),o.pixelSize=new Cesium.ConstantProperty(r.style.point.size),o.outlineColor=new Cesium.ConstantProperty(Cesium.Color.BLACK),o.outlineWidth=new Cesium.ConstantProperty(1),i.point=o;var s=a.defaultLine,n=new Cesium.DynamicPolyline,l=new Cesium.ColorMaterialProperty;l.color=new Cesium.ConstantProperty(C(r.style.line.color)),n.material=l,n.width=new Cesium.ConstantProperty(r.style.line.width),s.polyline=n;var c=a.defaultPolygon;c.polyline=n;var v=new Cesium.DynamicPolygon;v.fill=new Cesium.ConstantProperty(r.style.polygon.fill),c.polygon=v,l=new Cesium.ColorMaterialProperty,l.color=new Cesium.ConstantProperty(C(r.style.polygon.fillcolor)),v.material=l;var d=p(e);if(""!==d&&"EPSG:4326"!==d)h(d)?console.log("GeoJSONDataSource will convert this"):(console.log("===Going to spatial reference service to try to get proj4 string"),u(d,function(){console.log("ADD LOADING FUNC HERE")}));else{var _=JSON.stringify(e).length,S={tot:0,longest:0};y(e,"coordinates",function(e){T(e,S)}),console.log("finished",S),S.longest>100&&S.tot>1e5&&(m(e),console.log("downsampled object from",_,"bytes to",JSON.stringify(e).length))}if(void 0===r.map)a.load(e),this.dataSourceCollection.add(a),r.dataSource=a,r.extent||(r.extent=f(a));else{var D={color:"#ff7800",weight:5,opacity:.65};L.geoJson(e,{style:D}).addTo(r.map)}return r},t.exports=D},{"./GeoData":2,"./TableDataSource":4}],4:[function(e,t){"use strict";var r=e("./Dataset"),a=(Cesium.defaultValue,function(){this.czmlDataSource=new Cesium.CzmlDataSource,this.dataset=new r,this.show=!0,this.color=Cesium.Color.RED,this.pts_max=1e4,this.leadTimeMin=0,this.trailTimeMin=60,this.scale=1,this.scale_by_val=!0;var e=[{offset:0,color:"#00f"},{offset:.25,color:"#0ff"},{offset:.25,color:"#0ff"},{offset:.5,color:"#0f0"},{offset:.5,color:"#0f0"},{offset:.75,color:"#ff0"},{offset:.75,color:"#ff0"},{offset:1,color:"#f00"}];this.colorGradient=e,this.setColorGradient(e)});Cesium.defineProperties(a.prototype,{name:{get:function(){return this.czmlDataSource.name}},clock:{get:function(){return this.czmlDataSource.clock}},dynamicObjects:{get:function(){return this.czmlDataSource.dynamicObjects}},isLoading:{get:function(){return this.czmlDataSource.isLoading}},changedEvent:{get:function(){return this.czmlDataSource.changedEvent}},errorEvent:{get:function(){return this.czmlDataSource.errorEvent}},loadingEvent:{get:function(){return this.czmlDataSource.loadingEvent}}}),a.prototype.loadUrl=function(e){var t=this;this.dataset.loadUrl({url:e,callback:function(){t.setLeadTimeByPercent(0),t.setTrailTimeByPercent(1),t.czmlDataSource.load(t.getDataPointList(),"TableDataSource")}})},a.prototype.loadText=function(e){var t=this;this.dataset.loadText(e),t.setLeadTimeByPercent(0),t.setTrailTimeByPercent(1),t.czmlDataSource.load(t.getDataPointList(),"TableDataSource")},a.prototype.setCurrentVariable=function(e){var t=this;this.dataset.setCurrentVariable({variable:e,callback:function(){t.czmlDataSource.load(t.getDataPointList(),"TableDataSource")}})},a.prototype.czmlRecFromPoint=function(e){var t={billboard:{horizontalOrigin:"CENTER",verticalOrigin:"BOTTOM",image:"./images/pow32.png",scale:1,color:{rgba:[255,0,0,255]},show:[{interval:"2011-02-04T16:00:00Z/2011-04-04T18:00:00Z","boolean":!0}]},position:{cartographicDegrees:[0,0,0]}};t.billboard.color.rgba=this._mapValue2Color(e.val),t.billboard.scale=this._mapValue2Scale(e.val);for(var r=0;3>r;r++)t.position.cartographicDegrees[r]=e.pos[r];var a=e.time.addMinutes(-this.leadTimeMin),i=e.time.addMinutes(this.trailTimeMin);return t.billboard.show[0].interval=a.toIso8601()+"/"+i.toIso8601(),t},a.prototype.getDataPointList=function(){var e=this.dataset;if(!e._loadingData){for(var t=this.dataset.getPointList(),r=[],a=0;a<t.length;a++){var i=this.czmlRecFromPoint(t[a]);r.push(i)}return r}},a.prototype._getNormalizedPoint=function(e){var t=this.dataset;if(void 0===t||t.isNoData(e))return void 0;var r=t.getMinVal(),a=t.getMaxVal(),i=a===r?0:(e-r)/(a-r);return i},a.prototype._mapValue2Scale=function(e){var t=this.scale,r=this._getNormalizedPoint(e);return void 0!==r&&(t*=this.scale_by_val?1*r+.5:1),t},a.prototype._mapValue2Color=function(e){var t=this.dataImage;if(void 0===t)return this.color;var r=this._getNormalizedPoint(e),a=[0,0,0,0];if(void 0!==r){var i=4*Math.floor(r*(t.data.length/4-1));a=t.data.subarray(i,i+4),a[3]*=this.color.alpha}return a},a.prototype.setLeadTimeByPercent=function(e){if(this.dataset){var t=this.dataset;this.leadTimeMin=t.getMinTime().getMinutesDifference(t.getMaxTime())*e/100}},a.prototype.setTrailTimeByPercent=function(e){if(this.dataset){var t=this.dataset;this.trailTimeMin=t.getMinTime().getMinutesDifference(t.getMaxTime())*e/100}},a.prototype.createGradient=function(e){for(var t=e.canvas.width,r=e.canvas.height,a=e.createLinearGradient(0,0,0,r),i=this.colorGradient,o=0;o<i.length;o++)a.addColorStop(i[o].offset,i[o].color);e.fillStyle=a,e.fillRect(0,0,t,r)},a.prototype.setColorGradient=function(){document.getElementById("grad_div")||($("body").append('<div id="grad_div"></div>'),$("<canvas/>",{id:"gradCanvas",Width:64,Height:256,Style:"display: none"}).appendTo("#grad_div"));var e=$("#gradCanvas")[0],t=e.getContext("2d");this.createGradient(t),this.dataImage=t.getImageData(0,0,1,256)},a.prototype.destroy=function(){return Cesium.destroyObject(this)},t.exports=a},{"./Dataset":1}],5:[function(e,t){"use strict";function r(e){return!isNaN(parseFloat(e))&&isFinite(e)}function a(e){var t=e.split(/[/-]/);return 3===t.length&&(e=t[1]+"/"+t[0]+"/"+t[2]),e}var i={LON:0,LAT:1,ALT:2,TIME:3,SCALAR:4,ENUM:5},o=function(){this.vals=[],this.fNoData=1e-34,this.min=void 0,this.max=void 0,this.type=void 0,this.time_var=void 0,this.enum_list=void 0};o.prototype._calculateVarMinMax=function(){for(var e=this.vals,t=Number.MAX_VALUE,r=-Number.MAX_VALUE,a=0;a<e.length;a++)void 0===e[a]||null===e[a]?e[a]=this.fNoData:(t>e[a]&&(t=e[a]),r<e[a]&&(r=e[a]));this.min=t,this.max=r},o.prototype._calculateTimeMinMax=function(){for(var e=this.vals,t=e[0],r=e[0],a=1;a<e.length;a++)t.greaterThan(e[a])&&(t=e[a]),r.lessThan(e[a])&&(r=e[a]);this.min=t,this.max=r},o.prototype.processTimeVar=function(){function e(e){return Cesium.JulianDate.fromDate(new Date(e))}function t(e){var t=Cesium.JulianDate.fromDate(new Date("January 1, 1970 0:00:00"));return t=t.addDays(Math.floor(e)-25569),t=t.addSeconds(60*(e-Math.floor(e))*60*24)}function s(e){return Cesium.JulianDate.fromDate(Date.setTime(e))}function n(e){var t=new Cesium.JulianDate(0,0),r=e.toString(),a=parseInt(r.substring(0,4),10),i=parseInt(r.substring(4,7),10);if(14!==r.length||1950>a||a>2050||i>366)return t;var o=new Date;return o.setUTCFullYear(a),o.setUTCHours(r.substring(7,9),r.substring(9,11),r.substring(11,13)),t=Cesium.JulianDate.fromDate(o).addDays(i)}if(this.type===i.TIME){var l,u=new o,p=this.vals;l=parseInt(p[0],10)>5e5?0!==n(p[0]).getJulianDayNumber()?n:s:r(p[0])?t:e;var h=!1;try{for(var c=0;c<p.length;c++)u.vals[c]=l(p[c]);h=!0}catch(v){if(l===e){console.log("Trying swap of day and month in date strings"),u.vals=[];try{for(var c=0;c<p.length;c++)u.vals[c]=l(a(p[c]));h=!0}catch(v){}}}h?(u._calculateTimeMinMax(),this.time_var=u):(this.type=i.SCALAR,console.log("Unable to parse time variable"))}},o.prototype.processEnumVar=function(){if(this.type===i.ENUM){for(var e=[],t=0;t<this.vals.length;t++){this.vals[t]===this.fNoData&&(this.vals[t]="undefined");var r=e.indexOf(this.vals[t]);-1===r&&(r=e.length,e.push(this.vals[t])),this.vals[t]=parseFloat(r)}this.enum_list=e,this.calculateVarMinMax()}},o.prototype.guessVarType=function(e){function t(e,t){var e=e.toLowerCase();for(var r in t){var a=t[r].toLowerCase();if(0===e.indexOf(a)||-1!==e.indexOf(" "+a)||-1!==e.indexOf("_"+a))return!0}return!1}var r=[{hints:["lon"],type:i.LON},{hints:["lat"],type:i.LAT},{hints:["depth","height","elevation"],type:i.ALT},{hints:["time","date"],type:i.TIME}];for(var a in r)if(t(e,r[a].hints))return void(this.type=r[a].type);this.type=i.SCALAR},o.prototype.destroy=function(){return Cesium.destroyObject(this)},t.exports=o},{}],6:[function(e,t){t.exports={Variable:e("./Variable"),Dataset:e("./Dataset"),TableDataSource:e("./TableDataSource"),GeoData:e("./GeoData"),GeoDataCollection:e("./GeoDataCollection")}},{"./Dataset":1,"./GeoData":2,"./GeoDataCollection":3,"./TableDataSource":4,"./Variable":5}]},{},[6])(6)});